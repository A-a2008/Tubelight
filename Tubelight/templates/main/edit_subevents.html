{% extends 'base.html' %}
{% load static %}

{% block header %}
<header id="header">
    <h1>Edit Subevents</h1>
    <p>Edit your subevents here</p>
</header>
{% endblock %}

{% block content %}
<form method="post" action="{% url 'edit_subevents' template_id=template.id %}">
    {% csrf_token %}
    {% for subevent, services in subevents.items %}
        <h2>{{ subevent }}</h2>

        <div id="{{ subevent|slugify }}_placeholder" {% if services %} style="display:none;" {% endif %}>
            <center>Click on "Add Field" for {{ subevent }}</center>
        </div>

        <table id="{{ subevent|slugify }}_table" {% if not services %} style="display: none;" {% endif %}>
            <thead>
                <tr>
                    <th>Service</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody id="{{ subevent|slugify }}_body">
                <!-- Rows will be added dynamically -->
                {% if services %}
                    {% for service in services %}
                    <tr id="{{ subevent|slugify }}_row_{{ forloop.counter }}">
                        <td>
                            <select name="{{ subevent }}" required>
                                <option value="" disabled hidden>Select Service</option>
                                {% for option_view, option in service_options.items %}
                                <option value="{{ option }}" {% if option == service %}selected{% endif %}>
                                    {{ option_view }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <button type="button" class="button small" onclick="removeField('${subeventId}', ${fieldNum})">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
        <br>
        <button type="button" class="small primary" onclick="addField('{{ subevent|slugify }}', '{{ subevent }}')">Add Field</button>
        <hr>
    {% endfor %}
    <br>
    <input type="submit" value="Submit">
</form>

<script>
    const fieldCounters = {};

    function addField(subeventId, subeventName) {
        if (!fieldCounters[subeventId]) fieldCounters[subeventId] = 0;

        const placeholder = document.getElementById(`${subeventId}_placeholder`);
        const table = document.getElementById(`${subeventId}_table`);
        const tbody = document.getElementById(`${subeventId}_body`);

        if (tbody.children.length === 0) {
            placeholder.style.display = "none";
            table.style.display = "table";
        }

        fieldCounters[subeventId]++;
        const fieldNum = fieldCounters[subeventId];
        const inputNamePrefix = subeventName;

        const row = document.createElement("tr");
        row.setAttribute("id", `${subeventId}_row_${fieldNum}`);

        row.innerHTML = `
            <td>
                <select name="${inputNamePrefix}" required>
                    <option value="" disabled selected hidden>Select Service</option>
                    <option value="venue_booking">Venue Booking</option>
                    <option value="wedding_coordinator">Wedding Coordinator</option>
                    <option value="caterers">Food Caterers</option>
                    <option value="dj">DJ</option>
                    <option value="musicians">Musicians</option>
                    <option value="sound_system">Sound System</option>
                    <option value="lighting">Lighting</option>
                    <option value="photographers">Photographer</option>
                    <option value="photographer_videographers">Photographer + Videographers</option>
                    <option value="valet">Valet</option>
                    <option value="decorators">Decorators</option>
                    <option value="invitations">Invitations</option>
                    <option value="power_backup">Power Backup</option>
                    <option value="security">Security</option>
                    <option value="cleaning">Cleaning</option>
                    <option value="games_activity">Games & Activity</option>
                    <option value="screen">Screen</option>
                    <option value="stage_setup">Stage Setup</option>
                    <option value="furniture_rentals">Furniture Rentals</option>
                    <option value="return_gifts">Return Gifts</option>
                    <option value="games_cake_beverages">Games, Cake & Beverages</option>
                    <option value="religious_ritual_setup">Religious Ritual Setup</option>
                    <option value="priest_service">Priest Service</option>
                    <option value="devotional_group">Devotional Group</option>
                    <option value="prasadam_distribution">Prasadam / Bhog Distribution</option>
                    <option value="hearse_arrangement">Hearse Arrangement</option>
                    <option value="cremation">Cremation</option>
                    <option value="floral_wreaths">Floral Wreaths</option>
                    <option value="tent_seating_setup">Tent & Seating Setup</option>
                    <option value="religious_ceremony">Religious Ceremony</option>
                    <option value="trip_planning">Trip Planning</option>
                    <option value="accommodation_booking">Accommodation Booking</option>
                    <option value="vehicle_rental">Vehicle Rental</option>
                    <option value="group_meal_planning">Group Meal Planning / Packed Food</option>
                    <option value="tour_guide">Tour Guide</option>
                    <option value="communication_management">Communication Management</option>
                    <option value="first_aid">First AID</option>
                    <option value="booking_management">Booking Management</option>
                    <option value="certificate_distribution">Certificate Distribution</option>
                    <option value="graduation_dessert_table">Graduation Cake / Dessert Table</option>
                    <option value="event_coordinator">Event Coordinator</option>
                    <option value="waiters">Waiters</option>
                    <option value="bouncers">Bouncers</option>
                    <option value="other">Other</option>
                </select>
            </td>
            <td>
                <button type="button" class="button small" onclick="removeField('${subeventId}', ${fieldNum})">Delete</button>
            </td>
        `;

        tbody.appendChild(row);
    }

    function removeField(subeventId, fieldNum) {
        const row = document.getElementById(`${subeventId}_row_${fieldNum}`);
        if (row) row.remove();

        const tbody = document.getElementById(`${subeventId}_body`);
        const table = document.getElementById(`${subeventId}_table`);
        const placeholder = document.getElementById(`${subeventId}_placeholder`);

        if (tbody.children.length === 0) {
            table.style.display = "none";
            placeholder.style.display = "block";
        }
    }
</script>
{% endblock %}
