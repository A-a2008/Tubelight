{% extends 'base.html' %}
{% load static %}

{% block header %}
<header id="header">
    <h1>Create Service</h1>
    <p>Register a new service with Tubelight</p>
</header>
{% endblock %}

{% block content %}
<form action="{% url 'create_service' %}" method="post">
    {% csrf_token %}

    <label for="name">Service Name:</label>
    <input type="text" name="name" id="name" required><br><br>

    <h3>Fields:</h3>

    <div id="fields_placeholder">
        <center>Click on "Add Field" button</center>
    </div>

    <table id="fields_table" style="display: none;">
        <thead>
            <tr>
                <th>Field Name</th>
                <th>Data Type</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody id="fields_body">
            <!-- Dynamic rows go here -->
        </tbody>
    </table>

    <br>
    <button type="button" onclick="addField()" class="small primary">Add Field</button>
    <br><br>

    <label for="user_input_field">Select User Input Field:</label>
    <select name="user_input_field" id="user_input_field">
        <option value="" disabled selected hidden>Atleast 1 Field required</option>
    </select>

    <br><br>
    <input type="submit" value="Submit">
</form>

<script>
    let fieldCounter = 0;

    function addField() {
        const table = document.getElementById("fields_table");
        const tbody = document.getElementById("fields_body");
        const placeholder = document.getElementById("fields_placeholder");
        const userInputSelect = document.getElementById("user_input_field");

        fieldCounter++;
        const rowId = `field_row_${fieldCounter}`;
        const inputId = `field_name_input_${fieldCounter}`;

        // Show table, hide placeholder if first field
        if (tbody.children.length === 0) {
            placeholder.style.display = "none";
            table.style.display = "table";
        }

        const row = document.createElement("tr");
        row.id = rowId;

        row.innerHTML = `
            <td><input type="text" name="field_names" id="${inputId}" oninput="updateUserInputOptions()" required></td>
            <td>
                <select name="field_types" required>
                    <option value="" disabled selected hidden>Select Type</option>
                    <option value="text">Text</option>
                    <option value="number">Number</option>
                    <option value="boolean">Boolean</option>
                    <option value="select">Select</option>
                </select>
            </td>
            <td>
                <button type="button" onclick="removeField('${rowId}', '${inputId}')" class="button small">Delete</button>
            </td>
        `;

        tbody.appendChild(row);
        updateUserInputOptions();
    }

    function removeField(rowId, inputId) {
        const row = document.getElementById(rowId);
        if (row) row.remove();

        updateUserInputOptions();

        const tbody = document.getElementById("fields_body");
        const placeholder = document.getElementById("fields_placeholder");
        const table = document.getElementById("fields_table");

        if (tbody.children.length === 0) {
            table.style.display = "none";
            placeholder.style.display = "block";
        }
    }

    function updateUserInputOptions() {
        const select = document.getElementById("user_input_field");
        select.innerHTML = `
            <option value="None">None</option>
        `;


        const inputs = document.querySelectorAll('[id^="field_name_input_"]');
        inputs.forEach((input) => {
            if (input.value.trim()) {
                const option = document.createElement("option");
                option.value = input.value.trim();
                option.textContent = input.value.trim();
                select.appendChild(option);
            }
        });
    }
</script>
{% endblock %}
